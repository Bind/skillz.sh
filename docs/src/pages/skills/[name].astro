---
import { readFile } from "node:fs/promises";
import { join } from "node:path";
import Layout from '../../layouts/Layout.astro';
import PageContainer from '../../components/PageContainer.astro';
import Badge from '../../components/Badge.astro';
import SectionTitle from '../../components/SectionTitle.astro';
import { CodeBlock } from '../../components/CodeBlock';
import { SkillInstallationTabs } from '../../components/SkillInstallationTabs';
import type { RegistrySkill } from '../../types/registry';
import registryData from '../../data/registry.json';

interface FileEntry {
  filename: string;
  content: string;
  language: string;
}

interface UtilEntry {
  filename: string;
  content: string;
}

export async function getStaticPaths() {
  const data = registryData as { skills: RegistrySkill[] };
  
  const paths = await Promise.all(data.skills.map(async (skill) => {
    const fileEntries: FileEntry[] = [];
    const utilEntries: UtilEntry[] = [];
    
    // Read SKILL.md
    try {
      const skillMdPath = join(process.cwd(), "..", "skills", skill.name, "SKILL.md");
      const content = await readFile(skillMdPath, "utf-8");
      fileEntries.push({
        filename: "SKILL.md",
        content,
        language: "markdown",
      });
    } catch (e) {
      // File might not exist
    }
    
    // Read entry point files
    if (skill.files?.entry) {
      for (const [name, path] of Object.entries(skill.files.entry)) {
        try {
          const filePath = join(process.cwd(), "..", path);
          const content = await readFile(filePath, "utf-8");
          const filename = path.split("/").pop() || `${name}.ts`;
          fileEntries.push({
            filename,
            content,
            language: "typescript",
          });
        } catch (e) {
          // File might not exist
        }
      }
    }
    
    // Read utils if they exist
    if (skill.utils) {
      for (const util of skill.utils) {
        try {
          const utilPath = join(process.cwd(), "..", "utils", `${util}.ts`);
          const content = await readFile(utilPath, "utf-8");
          utilEntries.push({ filename: `${util}.ts`, content });
        } catch (e) {
          // File might not exist
        }
      }
    }
    
    return {
      params: { name: skill.name },
      props: { skill, fileEntries, utilEntries },
    };
  }));
  
  return paths;
}

const { skill, fileEntries, utilEntries } = Astro.props;

const installCmd = `bunx @bind/skillz add ${skill.name}`;
const envVars = skill.setup?.env || [];
const instructions = skill.setup?.instructions || "";
const depKeys = Object.keys(skill.dependencies || {});
---

<Layout title={skill.name} activePage="skills">
  <PageContainer size="lg">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-6">
      <div>
        <div class="flex items-center gap-2 mb-3">
          <Badge>v{skill.version}</Badge>
          {skill.domain && (
            <a href={`/skills/domain/${skill.domain}`}>
              <Badge class="capitalize hover:bg-gray-200 transition-colors">{skill.domain}</Badge>
            </a>
          )}
        </div>
        <h1 class="text-4xl font-bold tracking-tight text-gray-900 mb-2">{skill.name}</h1>
        <p class="text-lg text-gray-600">{skill.description}</p>
      </div>
      <div class="flex-shrink-0">
        <CodeBlock code={installCmd} client:load />
      </div>
    </div>

    <!-- Setup Section -->
    {envVars.length > 0 && (
      <section class="mb-12">
        <SectionTitle>Setup</SectionTitle>
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Environment Variables</h3>
          <p class="text-sm text-gray-600 mb-3">
            Add to a <code class="bg-gray-100 px-1 rounded">.env</code> file in your repo root, or export in your shell environment.
          </p>
          <CodeBlock code={envVars.map((v: string) => `${v}=your_value_here`).join("\n")} copyMode="hover" client:load />
          {instructions && (
            <p class="text-sm text-gray-500 mt-2">{instructions}</p>
          )}
        </div>
      </section>
    )}

    <!-- Installation Section -->
    <section class="mb-12">
      <SectionTitle>Installation</SectionTitle>
      <SkillInstallationTabs
        skillName={skill.name}
        installCmd={installCmd}
        fileEntries={fileEntries}
        utilEntries={utilEntries}
        depKeys={depKeys}
        envVars={envVars}
        client:load
      />
    </section>

  </PageContainer>
</Layout>
